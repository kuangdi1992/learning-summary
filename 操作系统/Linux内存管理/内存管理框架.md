# 内存管理框架

 整个内存管理从宏观上可以分为三大部分：**用户空间、内核空间和相关硬件**。

**用户空间**主要是libc对相关系统调用进行封装，对用户程序提供API，常用的有malloc、mmap、munmap、remap、madvise、mempolicy等等。

**相关硬件**包括MMU/TLB、L1/L2 Cache以及DDR RAM，具体到ARM架构需要对照MMU/L2 Cache以及RAM规格书。

**内核空间**就复杂多了，首先介绍初始化及初始化后的布局。

**物理内存初始化**从获取内存大小、初始化页表，再进行zone初始化，然后在zone中使用伙伴系统进行物理内存初始化；

**页表的映射过程**讲述了ARM32和ARM64两种架构下的页表映射，如何从虚拟地址由MMU转化成物理页面地址的；

**内核内存的布局图**在内存被初始化之后，内核的内存布局基本上就确定了，ARM32和ARM64下布局有很大区别。在malloc一节brk中介绍了用户空间的布局。

上面三章是内存的一个静态状态，在有了这些基础之后，下面就按照从低层到上层的逐个介绍了。

**分配物理页面**介绍了基于伙伴系统的页分配和释放；

**slab分配器**基于伙伴系统，slab分配更小内存块；以及基于slab的kmalloc；

**vmalloc**和kmalloc区别在于v，即在VMALLOC区域分配；

**[2.7 VMA](http://www.cnblogs.com/arnoldlu/p/8329279.html)**即Virtual Memory Area，是进程内存管理的核心；

**[2.8 malloc](http://www.cnblogs.com/arnoldlu/p/8329283.html)**和**[2.9 mmap](http://www.cnblogs.com/arnoldlu/p/8330785.html)**都基于VMA，malloc/free用于分配/释放一块内存；mmap/munmap用于匿名/文件映射到用户空间。以及**[mmap(补充)](https://www.cnblogs.com/arnoldlu/p/9367253.html)**。

由于malloc/mmap分配内存并不是立即分配，只是在用到的时候才会触发**[2.10 缺页中断处理](http://www.cnblogs.com/arnoldlu/p/8335475.html)**。

 

在缺页但页不足的情况下，就需要进行一些操作调整内存，这些操作的基础是**[2.11 page引用计数](http://www.cnblogs.com/arnoldlu/p/8335481.html)**，还有页面的**[2.12 反向映射RMAP](http://www.cnblogs.com/arnoldlu/p/8335483.html)**技术。

在内存不足情况下触发kswapd**[2.13 回收页面](http://www.cnblogs.com/arnoldlu/p/8335487.html)**，其中匿名页面有着特殊的**[2.14 匿名页面生命周期](http://www.cnblogs.com/arnoldlu/p/8335508.html)**。

在kswapd回收依然无法满足内存分配，就需要对内存进行**[2.16 内存规整](http://www.cnblogs.com/arnoldlu/p/8335532.html)**，它依赖的技术是**[2.15 页面迁移](http://www.cnblogs.com/arnoldlu/p/8335524.html)**。

由于内存中存在一些内容完全一样的页面，使用**[2.17 KSM](http://www.cnblogs.com/arnoldlu/p/8335541.html)**技术进行合并，同时利用COW技术，在需要时重新分配。

还介绍了**[2.18 Dirty COW](http://www.cnblogs.com/arnoldlu/p/8335546.html)**内存漏洞，然后对内存管理数据结构和API进行了总结**[2.19 总结内存管理数据结构和API](http://www.cnblogs.com/arnoldlu/p/8335568.html)**。

最后**[2.20 最新更新和展望](http://www.cnblogs.com/arnoldlu/p/8335587.html)**对新技术进行了介绍。

除了以上技术，还有如下内存技术：

- swap计数把匿名页面写入SWAP分区从而释放出空闲页面
- 内存压缩技术zram(a compressed RAM based swap device)
- zswap技术是zram和swap的一个综合，首先将待换出页面进行压缩，存储到系统RAM动态分配的内存池中；达到一定阈值后再写入实际交换设备。
- 在内存极端不足情况下使用**[21 ](http://www.cnblogs.com/arnoldlu/p/8567559.html)****[OOM](http://www.cnblogs.com/arnoldlu/p/8567559.html)**(Out-Of-Memory)来杀死不重要进程获取更多内存的技术
- 基于cgroup的Memory资源控制
- 解决多媒体对大量连续内存需求的CMA(Contiguous Memory Allocator)技术
- slub分配器
- memory hotplug内存热插拔支持动态更换内存物理设备

==============================================================================================================================

在对内存相关技术了解过后，就是如何运用的问题了？

一方面是对内存问题进行定位；另一方面是对内存行为施加影响，进行优化。

[**22 内存检测技术**](http://www.cnblogs.com/arnoldlu/p/8568090.html)对Linux内存常见问题及其定位方法和工具(slub_debug/kmemleak/kasan)进行了讲解。

**[23 一个内存Oops解析](http://www.cnblogs.com/arnoldlu/p/8672139.html)**以一个内存Oops为例，介绍了内存相关异常分析。

**[内存sysfs节点和工具](http://www.cnblogs.com/arnoldlu/p/8568330.html)**介绍了linux内存管理相关sysfs节点，以及工具；借助这些可以对内存进行优化。



![image-20211212113328710](F:\git资料\Learning-summary\Picture\linux\image-20211212113328710.png)