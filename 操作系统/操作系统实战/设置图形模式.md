# 介绍

在计算机加电启动时，计算机上显卡会自动进入文本模式。文本模式只能显示ASCII字符，不能显示汉字和图形，因此要让显卡切换到图形模式。

切换显卡模式要用到BIOS中断。在实模式切换显卡模式。

# 代码解读

路径：graph.c

```C++
void init_graph(machbstart_t* mbsp)
{
    graph_t_init(&mbsp->mb_ghparm);//初始化图形数据结构
    init_bgadevice(mbsp);
    if(mbsp->mb_ghparm.gh_mode!=BGAMODE)
    {
        get_vbemode(mbsp); //获取VBE模式，通过BIOS中断
        get_vbemodeinfo(mbsp);//获取一个具体VBE模式的信息，通过BIOS中断
        set_vbemodeinfo();//设置VBE模式，通过BIOS中断
    }

    init_kinitfvram(mbsp);
    logo(mbsp);
    return;
}
```

分解代码：

1、graph_t_init函数：初始化图形数据结构

```C++
void graph_t_init(graph_t* initp)
{
    memset(initp,0,sizeof(graph_t));
    return;
}
```

2、init_bgadevice函数，主要是更新机器信息结构中的数据

```C++
void init_bgadevice(machbstart_t* mbsp)
{
    u32_t retdevid=get_bgadevice();
    if(0==retdevid)
    {
        return;
    }
    retdevid=chk_bgamaxver();
    if(0==retdevid)
    {
        return;
    }
    bga_write_reg(VBE_DISPI_INDEX_ENABLE, VBE_DISPI_DISABLED);
    bga_write_reg(VBE_DISPI_INDEX_XRES, 1024);
    bga_write_reg(VBE_DISPI_INDEX_YRES, 768);
    bga_write_reg(VBE_DISPI_INDEX_BPP, 0x20);
    bga_write_reg(VBE_DISPI_INDEX_ENABLE, VBE_DISPI_ENABLED|(VBE_DISPI_LFB_ENABLED)); 
    mbsp->mb_ghparm.gh_mode=BGAMODE;
    mbsp->mb_ghparm.gh_vbemodenr=retdevid;
    mbsp->mb_ghparm.gh_x=1024;
    mbsp->mb_ghparm.gh_y=768;
    mbsp->mb_ghparm.gh_framphyadr=0xe0000000;
    mbsp->mb_ghparm.gh_onepixbits=0x20;
    mbsp->mb_ghparm.gh_bank=4;
    mbsp->mb_ghparm.gh_curdipbnk=0;
    mbsp->mb_ghparm.gh_nextbnk=0;
    mbsp->mb_ghparm.gh_banksz=(mbsp->mb_ghparm.gh_x*mbsp->mb_ghparm.gh_x*4);
    //test_bga();
    return;
}
```

3、get_vbemode函数，如果模式不是BGAMODE，就会进入VBE模式。

```C++
void get_vbemode(machbstart_t* mbsp)
{
    realadr_call_entry(RLINTNR(2),0,0);
    vbeinfo_t* vbeinfoptr=(vbeinfo_t*)VBEINFO_ADR;
    u16_t* mnm;

    if(vbeinfoptr->vbesignature[0]!='V'||
            vbeinfoptr->vbesignature[1]!='E'||
            vbeinfoptr->vbesignature[2]!='S'||
            vbeinfoptr->vbesignature[3]!='A')
    {
        kerror("vbe is not VESA");
    }
    kprint("vbe vbever:%x\n",vbeinfoptr->vbeversion);
    if(vbeinfoptr->vbeversion<0x0200)
    {
        kerror("vbe version not vbe3");
    }

    if(vbeinfoptr->videomodeptr>0xffff)
    {
        mnm=(u16_t*)vfartolineadr(vbeinfoptr->videomodeptr);//
    }
    else
    {
        mnm=(u16_t*)(vbeinfoptr->videomodeptr);
    }

    int bm=0;
    for(int i=0;mnm[i]!=0xffff;i++)
    {
        if(mnm[i]==0x118)
        {
            bm=1;
        }
        if(i>0x1000)
        {
            break;
        }

    }

    if(bm==0)
    {
        kerror("getvbemode not 118");
    }
    mbsp->mb_ghparm.gh_mode=VBEMODE;
    mbsp->mb_ghparm.gh_vbemodenr=0x118;
    mbsp->mb_ghparm.gh_vifphyadr=VBEINFO_ADR;
    m2mcopy(vbeinfoptr,&mbsp->mb_ghparm.gh_vbeinfo,sizeof(vbeinfo_t));
    return;
}
```

这里选择使用了 VBE 的 118h 模式，该模式下屏幕分辨率为 1024x768，显存大小是 16.8MB。显存开始地址一般为 0xe0000000。屏幕分辨率为 1024x768，即把屏幕分成 768 行，每行 1024 个像素点，但每个像素点占用显存的 32 位数据（4 字节，红、绿、蓝、透明各占 8 位）。我们只要往对应的显存地址写入相应的像素数据，屏幕对应的位置就能显示了。