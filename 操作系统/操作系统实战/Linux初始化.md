# 介绍

该小节主要是介绍linux的初始化的过程，需要结合《linux0.11—操作系统启动过程》一起理解。

目的：理解Linux上GRUB是怎样启动的，以及vmlinuz内核文件是如何产生和运转的【这个文件在kdump重启的时候用过很多，但是没有详细的研究过它的产生过程。】

# 全局流程

大致流程如下：

在机器加电后，BIOS 会进行自检，然后由 BIOS 加载引导设备中引导扇区。在安装有 Linux 操作系统的情况下，在引导扇区里，通常是安装的 GRUB 的一小段程序（安装 windows 的情况则不同）。最后，GRUB 会加载 Linux 的内核映像 vmlinuz。

如下图所示：

![img](https://static001.geekbang.org/resource/image/f3/b3/f3d8b95e8c1563466d31f385bb42aab3.jpg?wh=3543*2005)

详细过程如下：

1、按电源键，系统加电

2、CPU加电时，将CS:IP设置为0xF000:0xFFF0，按照实模式下的寻址规则，得到物理地址为0xFFFF0，即为BIOS启动程序位置，CPU直接读取命令并执行。【在这个物理地址上连接了主板上的一块小的 ROM 芯片。这种芯片的访问机制和寻址方式和内存一样，只是它在断电时不会丢失数据，在常规下也不能往这里写入数据，它是一种只读内存，BIOS 程序就被固化在该 ROM 芯片里。】

3、BIOS执行

3.1、BIOS首先执行POST自检，包括主板、内存、外设等，遇到问题则报警并停止引导

3.2、初始化CPU，检查并初始化内存，将自己的一部分复制到内存中，并跳转到内存中运行。

3.3、设备初始化和检查步骤完成后，BIOS会在内存中建立中断表和中断服务程序-------重要工作

![image-20220917110913462](C:\Users\kd\AppData\Roaming\Typora\typora-user-images\image-20220917110913462.png)

BIOS在程序最开始的位置，即0x00000，用1K的内存空间（0x00000~0x003FF）构建中断向量表，
并在紧挨他的位置用256字节的内存空间构建BIOS数据区（0x00400~0x004FF）,在大约56K的位置（0x0E2CE

）加载了8K左右的与中断向量表相应的若干中断服务程序。

![image-20220917111030445](C:\Users\kd\AppData\Roaming\Typora\typora-user-images\image-20220917111030445.png)

中断向量表中有256个中断向量，每个中断向量占有4个字节空间，其中2个字节是CS的值，2个是
IP的值，每个中断向量都指向一个具体的中断服务程序。

注释：
0x00100是256个字节，那么0x004000就是4*256个字节，即1024个字节，为1K。从0x00400开始
计算，1K的高端地址不是0x00400，是0x00400-1，即0x003FF。



3.4、Linux通常从硬盘启动，硬盘上的第一个扇区（每个扇区512字节）被称为MBR，其中包含了基本的GRUB启动程序和分区表，安装GRUB时会自动写入到这个扇区。——第一扇区中的程序由bootsect.s中的汇编程序汇编而成。

当MBR被BIOS装载到0x7c00地址开始的内存空间后，BIOS就会将控制权转交给MBR，即GRUB。

4、GRUB启动

因为硬盘上的第一个扇区只有512字节，无法装下GRUB这种大型通用引导器，因此，GRUB加载分成了多个步骤。

GRUB被分成多个文件，其中两个重要的文件boot.img和core.img，boot.img被GRUB的安装程序写入到硬盘的MBR中，同时在boot.img文件中的一个位置写入core.img文件占用的第一个扇区的扇区号。

core.img文件是由GRUB安装程序根据安装时环境信息，用其他GRUB模块文件动态生成的。

![img](https://static001.geekbang.org/resource/image/cb/4b/cb36d637ce0a0d7c38788102e139604b.jpg?wh=3180*1105)

如果是从硬盘启动，则core.img中的第一个扇区内容是diskboot.img文件。

diskboot.img文件的作用是读取core.img文件中剩余部分到内存中。