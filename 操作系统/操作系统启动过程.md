# 操作系统启动过程

## 计算机执行的第一条指令

问题：打开电源后，计算机执行的第一句指令是什么？

对于x86的PC机，刚上电时，有一部分是固化的，基本过程如下：

1. x86 PC刚开机时CPU处于实模式
2. 开机时，CS=0xFFFF；IP=0x0000
3. 寻址0xFFFF0（ROM BIOS映射区---固化在硬件上）
4. 检查RAM、键盘、显示器、软硬磁盘
5. 将磁盘0磁道0扇区（引导扇区）读入0x7c00处，也就是将操作系统引导扇区从磁盘中读入到0x7c00处
6. 设置CS=0x07c0，IP=0x0000，通过寻址，后面将从引导扇区开始执行，也就是从0x7c00处开始执行。

实模式下的寻址CS：IP----->CS左移4位+IP，例如CS=0xFFFF；IP=0x0000则CS左移4位为0xFFFF0，再加上IP，为0xFFFF0，也就是ROM上的BIOS映射区。

![image-20210816221601955](https://github.com/kuangdi1992/Interview-knowledge/blob/master/Picture/linux/image-20210816221601955.png)

## 0x7c00处存放的代码

0x7c00处存放的代码是从引导扇区读入的512个字节。

- 引导扇区是启动设备的第一个扇区
- 硬盘的第一个扇区上存放着开启后执行的第一段可控制的程序。

Linux最前面的部分是由8086汇编语言编写的bootsect.s，它将由BIOS读入到内存绝对地址0x7c00(31KB)处，当它被执行的时候会将自己移动到内存绝对地址0x90000(576KB)处，并把启动设备中后2KB字节代码(boot/setup.s)读入到内存0x90200处，而内核的其他部分system模块被读入到从内存地址0x10000(64KB)开始处，因此从机器加点开始顺序执行如图所示：

![image-20210817222121681](C:\Users\kd\AppData\Roaming\Typora\typora-user-images\image-20210817222121681.png)

### 引导扇区代码:bootsect.s

引导扇区中的代码是汇编代码。C程序要经过编译，经过编译后会产生不可控制的变化，而汇编中的每一条指令最后都变成了真正的机器指令，可以对它进行完整的控制。

开始设置相关的段地址，如下：

```
BOOTSEG  = 07c0h;// bootsect的原始地址（是段地址，以下同）
INITSEG  = 9000h;// 将bootsect移到这里
SETUPSEG = 9020h;// setup程序从这里开始
SYSSEG   = 1000h;// system模块加载到10000(64kB)处.
```



```
entry _start  告知链接程序，程序从start标号开始执行
_start:
	mov	ax,#BOOTSEG
	mov	ds,ax
	mov	ax,#INITSEG
	mov	es,ax
	mov	cx,#256
	sub	si,si
	sub	di,di
	rep
	movw
	jmpi	go,INITSEG
```

