# 介绍

我们可以通过筛选条件where和having，或者是限定返回记录的关键字limit返回一条记录，但是无法在结果集中像指针一样，向前定位一条记录，或者向后定位一条记录，或者是随意定位到某一条记录，并对记录的数据进行处理。这个时候可以使用游标。

游标：让SQL这种面向集合的语言有了面向过程开发的能力。

MySQL游标可以在存储过程和函数中使用。

在SQL中，游标是一种临时的数据库对象，可以指向存储在数据库表中的数据行指针。可以通过操作游标来对数据行进行操作。

# 使用步骤

游标必须在声明处理程序之前被声明，并且变量和条件还必须在声明游标或者处理程序之前被声明。

## 声明游标

在MySQL中，使用DECLARE关键字来声明游标，其语法的基本形式如下：

```sql
DECLARE cursor_name CURSOR FOR select_statement;
```

这个语法适用于 MySQL，SQL Server，DB2 和 MariaDB。如果是用 Oracle 或者 PostgreSQL，需要写成：

```sql
DECLARE cursor_name CURSOR IS select_statement;
```

要使用 SELECT 语句来获取数据结果集，而此时还没有开始遍历数据，这里 select_statement 代表的是
SELECT 语句，返回一个用于创建游标的结果集。

示例：

```sql
DECLARE cur_emp CURSOR FOR
SELECT employee_id,salary FROM employees;
```

## 打开游标

语法：

```sql
OPEN cursor_name
```

当我们定义好游标之后，如果想要使用游标，必须先打开游标。打开游标的时候 SELECT 语句的查询结果集就会送到游标工作区，为后面游标的**逐条读取**结果集中的记录做准备。

示例：

```sql
OPEN　cur_emp ;
```

## 使用游标

语法如下：

```sql
FETCH cursor_name INTO var_name [, var_name] ...
```

这句的作用是使用cursor_name这个游标来读取当前行，并且将数据保存到var_name变量中，游标指针指到下一行。如果游标读取的数据行有多个列名，则在INTO关键字后赋值给多个变量名即可。

注意：var_name必须在声明游标之前就定义好。

```sql
FETCH　cur_emp INTO emp_id, emp_sal ;
```

游标结果集中的字段数必须和INTO后面跟着的变量数一致。

## 关闭游标

```sql
CLOSE cursor_name
```

有 OPEN 就会有 CLOSE，也就是打开和关闭游标。当我们使用完游标后需要关闭掉该游标。因为游标会占用系统资源 ，如果不及时关闭，游标会一直保持到存储过程结束，影响系统运行的效率。而关闭游标的操作，会释放游标占用的系统资源。

# 举例

创建存储过程“get_count_by_limit_total_salary()”，声明IN参数limit_total_salary，DOUBLE类型；声明OUT参数total_count，INT类型。函数的功能可以实现累加薪资最高的几个员工的薪资值，直到薪资总和达到limit_total_salary参数的值，返回累加的人数给total_count。

```sql
CREATE PROCEDURE get_count_by_limit_total_salary(IN limit_total_salary DOUBLE,OUT total_count INT)
BEGIN
  #记录累加工资总和
	DECLARE sum_salary DOUBLE DEFAULT 0.0;
	#记录某一个工资值
	DECLARE cursor_salary DOUBLE DEFAULT 0.0;
	#记录个数
	DECLARE emp_count INT DEFAULT 0;
	
	#定义游标
	DECLARE emp_cursor CURSOR FOR
	SELECT salary
	FROM employees
	ORDER BY salary DESC;
	
	#打开游标
	OPEN emp_cursor;
	
	#使用游标
	REPEAT
		FETCH emp_cursor INTO cursor_salary;
		SET sum_salary = sum_salary + cursor_salary;
		SET emp_count = emp_count + 1;
	
		UNTIL sum_salary >= limit_total_salary 
	END REPEAT;
	
	SET total_count = emp_count;
	
	CLOSE emp_cursor;
END;

SET @limit_total_salary := 200000;
SET @total_count := 0;
CALL get_count_by_limit_total_salary(@limit_total_salary,@total_count);
SELECT @total_count;
```

# 小结

游标是 MySQL 的一个重要的功能，为**逐条读取**结果集中的数据，提供了完美的解决方案。跟在应用层面实现相同的功能相比，游标可以在存储程序中使用，效率高，程序也更加简洁。
但同时也会带来一些性能问题，比如在使用游标的过程中，会对数据行进行加锁 

，这样在业务并发量大的时候，不仅会影响业务之间的效率，还会 消耗系统资源 ，造成内存不足，这是因为游标是在内存中进行的处理。
建议：**养成用完之后就关闭的习惯，这样才能提高系统的整体效率**。