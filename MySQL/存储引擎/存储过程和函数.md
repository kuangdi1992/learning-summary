# 存储过程和函数

## 介绍

存储过程和函数是事先经过编译并存储在数据库中的一段SQL语句的集合。

调用存储过程和函数可以简化应用开发人员的很多工作，减少数据在数据库和应用服务器之间的传输，对于提高数据处理的效率是有好处的。

存储过程和函数的区别：

1. 函数必须有返回值，存储过程没有
2. 存储过程的参数可以使用IN、OUT、INOUT类型，而函数的参数只能是IN类型。
3. 如果有函数从其他类型的数据库迁移到MySQL，可能因此需要将函数改造成存储过程。

## 相关操作

### 前提

确认用户是否具有相应的权限。

- 创建存储过程和函数——create routine权限
- 修改或删除存储过程和函数——alter routine权限
- 执行存储过程和函数——execute权限

### 创建存储过程

#### 语法

```sql
create procedure 存储过程名字
(
   [in|out|inout] 参数 datatype
)
begin
   MySQL 语句;
end;

IN：输入参数
OUT：输出参数
INOUT：既作为输入参数，也作为输出参数
```

存储过程参数如果不显示指定in、out、inout，则默认为in。

#### 特点

1、MySQL 存储过程名字后面的“()”是必须的，即使没有一个参数，也需要“()” 。

2、MySQL 存储过程参数，不能在参数名称前加“@”，如：“@a int”。下面的创建存储过程语法在 MySQL 中是错误的（在 SQL Server 中是正确的）。 MySQL 存储过程中的变量，不需要在变量名字前加“@”。

```sql
create procedure pr_add
(
   @a int,  -- 错误
   b int    -- 正确
)
```

3、存储过程的参数不能指定默认值。

4、存储过程不需要在procedure body前加上as。

```sql
create procedure pr_add
(
   a int,
   b int
)
as              -- 错误，MySQL 不需要 “as”
begin
   mysql statement ...;
end;
```

5、如果存储过程中包含多条sql语句，则需要begin、end关键字。

```sql
create procedure pr_add
(
   a int,
   b int
)
begin
   mysql statement 1 ...;
   mysql statement 2 ...;
end;
```

6、存储过程中的每条语句的莫问，都要加上分号“;”。

```sql
   ...
   declare c int;
   if a is null then
      set a = 0;
   end if;
   ...
end;
```

7、存储过程的注释。

```sql
   declare c int;     -- 这是单行 MySQL 注释 （注意 -- 后至少要有一个空格）
   if a is null then  # 这也是个单行 MySQL 注释
      set a = 0;
   end if;
   ...
end;
```

8、不能在MySQL存储过程中使用return关键字。

```sql
set c = a + b;
   select c as sum;
   
end;
```

9、调用存储过程时，需要在过程名字后面加上()，即使没有参数。

```sql
call pr_no_param();
```

10、存储过程参数没有默认值，所以在调用存储过程时不能省略参数，可以用null代替。

```sql
call pr_add(10, null);
```

11、存储过程中允许包含DDL语句，也允许在存储过程中执行提交commit或者回滚rollback，但是不允许执行load data infile语句。

#### 示例

```sql
mysql> delimiter $$
mysql> create procedure file_order
(
	IN order_num INT,
	OUT order_count INT
) 
begin 
	select order_num from orders; 
	select found_rows() into order_count;
end $$
Query OK, 0 rows affected (0.12 sec)
mysql> delimiter;


mysql> call file_order(20005,@a);
+-----------+
| order_num |
+-----------+
|     20005 |
|     20005 |
|     20005 |
|     20005 |
|     20005 |
+-----------+
5 rows in set (0.06 sec)

Query OK, 1 row affected (0.04 sec)

mysql> select @a;
+----+
| @a |
+----+
|  5 |
+----+
1 row in set (0.02 sec)
```

注意：通常在创建存储过程之前，会通过`delimiter $$`命令将语句的结束符，从";"改成其他符号，这里使用的是"$$"，这样在存储过程中的";"就不会被mysql解释成语句的结束而提示错误。

存储过程创建完毕后，通过`delimiter ;`将结束符改为";"。

### 创建函数

#### 语法

```sql
CREATE FUNCTION func_name ( [func_parameter] ) //括号是必须的，参数是可选的
RETURNS type
[ characteristic ...] routine_body
```

- CREATE FUNCTION 用来创建函数的关键字；
- func_name 表示函数的名称；
- func_parameters为函数的参数列表，参数列表的形式为：[IN|OUT|INOUT] param_name type
  1. IN：表示输入参数；
  2. OUT：表示输出参数；
  3. INOUT：表示既可以输入也可以输出；
  4. param_name：表示参数的名称；
  5. type：表示参数的类型，该类型可以是MySQL数据库中的任意类型；
- RETURNS type：语句表示函数返回数据的类型；
- characteristic: 指定存储函数的特性，取值与存储过程时相同，

#### 示例

创建表并插入数据

```sql
create table employees
(
	employee_id int(11) primary key not null auto_increment,
	employee_name varchar(50) not null,
	employee_sex varchar(10) default '男',
	hire_date datetime not null default current_timestamp,
	employee_mgr int(11),
	employee_salary float default 3000,
	department_id int(11)
);
 
 
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('David Tian','男',10,7500,1);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Black Xie','男',10,6600,1);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Moses Wang','男',10,4300,1);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Rena Ruan','女',10,5300,1);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Sunshine Ma','女',10,6500,2);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Scott Gao','男',10,9500,2);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Warren Si','男',10,7800,2);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Kaishen Yang','男',10,9500,3);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Simon Song','男',10,5500,3);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Brown Guan','男',10,5000,3);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Eleven Chen','女',10,3500,2);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Cherry Zhou','女',10,5500,4);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Klause He','男',10,4500,5);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Maven Ma','男',10,4500,6);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Stephani Wang','女',10,5500,7);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Jerry Guo','男',10,8500,1);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Gerardo Garza','男',10,25000,8);
insert into employees(employee_name,employee_sex,employee_mgr,employee_salary,department_id) values ('Derek Wu','男',10,5500,5);
 
 
select * from employees;
```

![image-20211211211514136](https://github.com/kuangdi1992/Interview-knowledge/blob/master/Picture/MySQL/image-20211211211514136.png)

创建函数－根据ID获取员工姓名与员工工资

```sql
DELIMITER $$
CREATE FUNCTION GetEmployeeInformationByID(id INT)
RETURNS VARCHAR(300)
BEGIN
	RETURN(SELECT CONCAT('employee name:',employee_name,'---','salary: ',employee_salary) FROM employees WHERE employee_id=id);
END$$
DELIMITER ;

mysql> select GetEmployeeInformationByID(1);
+-----------------------------------------+
| GetEmployeeInformationByID(1)           |
+-----------------------------------------+
| employee name:David Tian---salary: 7500 |
+-----------------------------------------+
1 row in set (0.04 sec)
```

### 删除存储过程或函数

语法

```sql
drop {procedure | function} [if exists] sp_name
```

示例

删除存储过程file_order

```sql
mysql> drop procedure if exists file_order;
Query OK, 0 rows affected (0.07 sec)

mysql> show procedure status like 'file_order';
Empty set
```



### 查看存储过程或函数

#### 查看存储过程或函数的状态

语法

```sql
show {procedure | function} status [like 'pattern']
```

示例

查看存储过程file_order的状态：

```sql
mysql> show procedure status like 'file_order';
+-------+------------+-----------+----------------+---------------------+---------------------+---------------+---------+----------------------+----------------------+--------------------+
| Db    | Name       | Type      | Definer        | Modified            | Created             | Security_type | Comment | character_set_client | collation_connection | Database Collation |
+-------+------------+-----------+----------------+---------------------+---------------------+---------------+---------+----------------------+----------------------+--------------------+
| mysql | file_order | PROCEDURE | root@localhost | 2021-12-11 17:48:39 | 2021-12-11 17:48:39 | DEFINER       |         | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
+-------+------------+-----------+----------------+---------------------+---------------------+---------------+---------+----------------------+----------------------+--------------------+
1 row in set (0.06 sec)
```

#### 查看存储过程或函数的定义

语法

```sql
show create {procedure | function} sp_name
```

示例

查看存储过程file_order的定义

```sql
mysql> show create procedure file_order;
+------------+-----------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure  | sql_mode                                                                                                              | Create Procedure                                                                                                                                                           | character_set_client | collation_connection | Database Collation |
+------------+-----------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| file_order | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION | CREATE DEFINER=`root`@`localhost` PROCEDURE `file_order`(IN order_num INT,OUT order_count INT)
begin select order_num from orders; select found_rows() into order_count;end | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
+------------+-----------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.02 sec)
```

#### 通过查看information_schema.Routines了解存储过程和函数的信息

示例

```sql
mysql> select * from information_schema.routines where routine_name='file_order';
+---------------+-----------------+----------------+--------------+--------------+-----------+--------------------------+------------------------+-------------------+---------------+--------------------+--------------------+----------------+----------------+--------------+------------------------------------------------------------------------------+---------------+-------------------+-----------------+------------------+-----------------+----------+---------------+---------------------+---------------------+-----------------------------------------------------------------------------------------------------------------------+-----------------+----------------+----------------------+----------------------+--------------------+
| SPECIFIC_NAME | ROUTINE_CATALOG | ROUTINE_SCHEMA | ROUTINE_NAME | ROUTINE_TYPE | DATA_TYPE | CHARACTER_MAXIMUM_LENGTH | CHARACTER_OCTET_LENGTH | NUMERIC_PRECISION | NUMERIC_SCALE | DATETIME_PRECISION | CHARACTER_SET_NAME | COLLATION_NAME | DTD_IDENTIFIER | ROUTINE_BODY | ROUTINE_DEFINITION                                                           | EXTERNAL_NAME | EXTERNAL_LANGUAGE | PARAMETER_STYLE | IS_DETERMINISTIC | SQL_DATA_ACCESS | SQL_PATH | SECURITY_TYPE | CREATED             | LAST_ALTERED        | SQL_MODE                                                                                                              | ROUTINE_COMMENT | DEFINER        | CHARACTER_SET_CLIENT | COLLATION_CONNECTION | DATABASE_COLLATION |
+---------------+-----------------+----------------+--------------+--------------+-----------+--------------------------+------------------------+-------------------+---------------+--------------------+--------------------+----------------+----------------+--------------+------------------------------------------------------------------------------+---------------+-------------------+-----------------+------------------+-----------------+----------+---------------+---------------------+---------------------+-----------------------------------------------------------------------------------------------------------------------+-----------------+----------------+----------------------+----------------------+--------------------+
| file_order    | def             | mysql          | file_order   | PROCEDURE    |           | NULL                     | NULL                   | NULL              | NULL          | NULL               | NULL               | NULL           | NULL           | SQL          | begin select order_num from orders; select found_rows() into order_count;end | NULL          | SQL               | SQL             | NO               | CONTAINS SQL    | NULL     | DEFINER       | 2021-12-11 17:48:39 | 2021-12-11 17:48:39 | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION |                 | root@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
+---------------+-----------------+----------------+--------------+--------------+-----------+--------------------------+------------------------+-------------------+---------------+--------------------+--------------------+----------------+----------------+--------------+------------------------------------------------------------------------------+---------------+-------------------+-----------------+------------------+-----------------+----------+---------------+---------------------+---------------------+-----------------------------------------------------------------------------------------------------------------------+-----------------+----------------+----------------------+----------------------+--------------------+
1 row in set (0.07 sec)
```

