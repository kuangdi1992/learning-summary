# 数据库的存储结构：页

索引结构提供了高效的索引方式，索引信息和数据记录是保存在文件上的，准确的说是存储在页结构中。

另外，索引是在存储引擎中实现的，MySQL服务器上的存储引擎负责对表中数据的读取和写入。不同的存储引擎中存放的格式一般是不同的。

## 磁盘与内存交互的基本单位：页

InnoDB将数据划分为若干个页，InnoDB中页的大小默认为16KB。

以页为磁盘和内存之间交互的基本单位，也就是一次最少从磁盘中读取16KB的内容到内存中，一次最少把内存中的16KB内容刷新到磁盘中。

**在数据库中，无论读一行，还是读多行，都是将这些行所在的页进行加载。**

**数据库管理存储空间的基本单位是页，数据库IO操作最小单位是页。**

![image-20230620084424347](C:\Users\kd\AppData\Roaming\Typora\typora-user-images\image-20230620084424347.png)

一个页中可以存储多个行记录。

## 页结构

页可以不在物理结构上相连，只要通过双向链表相关联即可。

每个数据页的记录会按照主键值从小到大顺序组成一个单向链表，每个数据页会为存储在它里面的记录生产一个页目录，在通过主键查找某条记录时可以在页目录中使用二分法快速定位到对应的槽，然后遍历该槽对应分组中的记录即可快速找到指定的记录。

## 页的大小

不同DBMS中页大小不同。

```sql
mysql> show variables like '%innodb_page_size%';
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| innodb_page_size | 16384 |
+------------------+-------+
1 row in set, 1 warning (0.00 sec)
```

SQL Server中页的大小为8KB，Oracle中用Block块表示页，支持2KB、4KB、8KB、16KB、32KB、64KB。

## 页的上层结构

在数据库中，还存在着区（Extent）、段（Segment）、表空间（Tablespace）的概念。

关系如下：

![image-20230620085712318](C:\Users\kd\AppData\Roaming\Typora\typora-user-images\image-20230620085712318.png)

- 区：比页大一级的存储结构，在InnoDB存储引擎中，一个区会分配64个连续的页。一个区的大小是64*16KB=1MB。
- 段：一个或多个区组成，区在文件系统中是一个连续分配的空间，在段中不要求区与区之间是相邻的。**段是数据库中的分配单位，不同类型的数据库对象以不同的段形式存在。**当我们创建数据表、索引的时候，会相应创建对应的段，比如创建一张表时会创建一个表段，创建一个索引会创建一个索引段。
- 表空间：逻辑容器，表空间存储的对象是段，在一个表空间中可以有一个或多个段，但是一个段只能属于一个表空间。数据库由一个或多个表空间组成，表空间从管理上可以划分为**系统表空间、用户表空间、撤销表空间、临时表空间等**。

## 数据页的内部结构

页按照类型划分的话，常见的有**数据页(保存B+树节点)、系统页、Undo页和事务数据页等**。数据页是最常使用的页。

数据页的16KB大小的存储空间被划分为7个部分，分别是文件头、页头、最大最小记录、用户记录、空闲空间、页目录和文件尾。

![image-20230622174223249](C:\Users\kd\AppData\Roaming\Typora\typora-user-images\image-20230622174223249.png)

说明如下：

![image-20230622174237846](C:\Users\kd\AppData\Roaming\Typora\typora-user-images\image-20230622174237846.png)

### 第一部分：File Header（文件头部）和File Trailer（文件尾部）

File Header

- 作用：各种页的通用信息。（比如页的编号、上一页、下一页是谁等）

- 大小：38字节

- 构成

  ![image-20230622174453706](C:\Users\kd\AppData\Roaming\Typora\typora-user-images\image-20230622174453706.png)

FIL_PAGE_OFFSET

- 页号，每个页单独的页号，InnoDB通过页号可以唯一定位一个页。

FIL_PAGE_TYPE

- 当前页的类型

  ![image-20230622174628939](C:\Users\kd\AppData\Roaming\Typora\typora-user-images\image-20230622174628939.png)

FIL_PAGE_PREV和FIL_PAGE_NEXT

InnoDB是以页为单位存放数据的，如果数据分散到多个不连续的页中存储的话，需要将这些页关联起来，FIL_PAGE_PREV和FIL_PAGE_NEXT分别代表本页的上一页和下一页的页号。这样通过建立一个双向链表把许许多多的页都串联起来了，保证这些页之间不需要物理上的连续，是逻辑上的连续。

![image-20230622174920179](C:\Users\kd\AppData\Roaming\Typora\typora-user-images\image-20230622174920179.png)

FIL_PAGE_SPACE_OR_CHKSUM

- 当前页面的校验和
- 文件头部和尾部都有该属性
- 